# 查重清理管理文档 (Deduplication Management Documentation)

本文档说明了 `read-comics` 系统中查重任务及其配套清理功能的实现逻辑与操作指南。

---

## 1. 系统架构与流程

查重清理功能采用了“任务异步扫描 + 后端合并清理 + 管理端可视化操作”的流程。

### 1.1 扫描原理 (TasksProcessor)

- **哈希计算**: 利用任务队列 (`deduplicate` 类型)，系统会扫描所有漫画文件路径，对没有 Hash 记录的漫画通过 `crypto` 计算其文件的全量特征哈希 (SHA-256)。
- **哈希持久化**: 计算结果存入 `comic.hash` 字段，后续扫描将复用该值以提升速度。
- **分组汇总**: 将具有相同哈希值的记录归为一组，任务完成后生成包含详细结果的 `JSON` 报告。

### 1.2 合并逻辑 (ComicsService.mergeDuplicates)

当管理员选择保留某一个副本并清理其他副本时，后端执行以下逻辑：

1. **数据迁移**:
   - **收藏记录**: 将所有属于“被删除副本”的收藏记录 (Favorites) 迁移到“保留副本”上。
   - **阅读进度**: 迁移阅读进度 (ReadingProgress)。若双方都有同一章节的进度，则保留进度百分比最高（更靠后）的那一条记录。
2. **物理文件清理**:
   - 物理删除被清理漫画对应的磁盘文件（仅当物理路径不同时，避免误删）。
3. **数据库清理**: 删除对应的数据库记录。

---

## 2. 管理员操作指南

### 2.1 发起扫描

1. 进入“管理后台” -> “任务队列”。
2. 点击“新建任务”，选择类型为 **“查重清理”**。
3. 等待任务状态变为“已完成”。

### 2.2 查看报告与清理

1. 在已完成的任务行中点击“**报告**”按钮。
2. 报告窗口会展示所有发现的重复文件组，包括每个文件的标题和物理路径。
3. 仔细核对路径后，点击对应副本旁边的“**保留此份并清理其他**”。
4. 确认后，系统将执行数据合并与磁盘静默清理。

---

## 3. 技术规范

- **状态码**:
  - 触发合并后，关联的删除操作将同步更新数据库状态。
  - **安全性**: 该操作仅管理员权限可执行，且所有删除操作均通过 `PathUtils` 进行安全路径过滤。
- **性能**:
  - 大规模库建议分批次发起扫描。
  - 哈希计算属于 CPU 密集型任务，已在独立处理器进程中运行，不会阻塞主 API。
